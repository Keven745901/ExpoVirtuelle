<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://aframe.io/releases/0.8.2/aframe.min.js"> </script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.0/dist/aframe-extras.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v4.0.1/dist/aframe-physics-system.min.js"></script>

</head>
<script>
    let listeCoordonnees = [];
    let gomme = false;
    let porte = false;
    window.onload = function () {
        
        GenererTableau();
        document.querySelector("#table").onmouseover = GetCoordonnees;
        document.querySelector("#table").onmousedown = GetCoordonnees;
        document.querySelector("#chkgomme").onclick = function(event) {
            if(event.target.checked){
                gomme = true;
                porte = false;
                document.querySelector("#chkporte").checked = false;
            }
            else{
                gomme = false;
            } 
        };

        document.querySelector("#chkporte").onclick = function(event) {
            if(event.target.checked){
                porte = true;
                gomme = false;
                document.querySelector("#chkgomme").checked = false;
            }
            else{
                porte = false;
            } 
        };
        document.querySelector("#btnvider").onclick = function(){
            listeCoordonnees = [];
            GenererTableau();
        };
        document.querySelector("#btngenerer").onclick = GenererExpo;

        document.querySelector("#camera").addEventListener("collide",function(e){
            console.log('Player has collided with ', e.detail.body.el);
            console.log(e.detail.target.el); // Original entity (camera).
            
            console.log(e.detail.contact); // Stats about the collision (CANNON.ContactEquation).
            console.log(e.detail.contact.ni); // Normal (direction) of the collision (CANNON.Vec3).
            
        });
    }

    function GenererExpo(){
        console.log({listeCoordonnees});
        let scene = document.querySelector("#scene");
        
        
        //permet de supprimer toutes les box de la scène
        while(scene.childNodes.length > 12){
            scene.removeChild(scene.childNodes[scene.childNodes.length-1]);
        }

        let box;
        //version Kévin
        /* 
        let maxelement=listeCoordonnees[0];
        let minelement=listeCoordonnees[0];

        listeCoordonnees.forEach(element => {
            if(maxelement.z === element.z)
            {
                if(maxelement.x < element.x)
                {
                    maxelement=element;
                }
                if(minelement.x > element.x)
                {
                    minelement=element;
                }
            }

        });
        maxelement.x=maxelement.x+1;
        box = document.createElement("a-box");
            box.setAttribute("id", 1);
            box.setAttribute("position", {
                x: minelement.x,
                y: 0,
                z: minelement.z
        });
        let murx=(maxelement.x - minelement.x);
        console.log(murx);
        box.setAttribute("width", murx)
        box.setAttribute("height", "4");
        box.setAttribute("color", "red");
        scene.appendChild(box);

        console.log("max x : " + maxelement.x);
        console.log("max y : " + maxelement.z);
        console.log("min x : " + minelement.x);
        console.log("min y : " + minelement.z);
        */
        
        listeCoordonnees.forEach(element => {
            box = document.createElement("a-box");
            box.setAttribute("id", listeCoordonnees.indexOf(element));
            box.setAttribute("position", {
                x: element.x,
                y: element.y,
                z: element.z
            });
            if(element.y === 1.5){
                box.setAttribute("height", "1");
            }
            else{
                box.setAttribute("height", "4");
                box.setAttribute("repeat", "1 4");
            }
            box.setAttribute("static-body", "");
            box.setAttribute("src", "assets/cobblestone.png");
            scene.appendChild(box);
        });
    }

    function MajListe(lst,x,z){
        console.log(event)
        if(lst !== undefined){
            let contenu = false;
            lst.forEach(element => {
                if(element.x === x && element.z === z){
                    contenu = true;
                    if(gomme || event.altKey){
                        lst.splice(lst.indexOf(element),1);
                        event.target.style.backgroundColor = "white";
                    }
                    else{
                        if(element.y === 0 && (event.ctrlKey || porte)){
                            element.y = 1.5;
                            event.target.style.backgroundColor = "green";
                        }
                        else{
                            if(!event.ctrlKey && !porte){
                                element.y = 0;                          
                                event.target.style.backgroundColor = "red";
                            }
                        }
                    }
                }
            });
            if(!contenu && !gomme && !event.altKey){
                if(!porte && !event.ctrlKey){
                    event.target.style.backgroundColor = "red";
                    lst.push({
                        x: x,
                        y: 0,
                        z: z
                    });
                }
                else{
                    event.target.style.backgroundColor = "green";
                    lst.push({
                        x: x,
                        y: 1.5,
                        z: z
                    });
                }
            }
        }
    }
    
    function GetCoordonnees(event){
        if(event.buttons === 1 ||event.type === "mousedown"){
            if(event.target.cellIndex !== undefined && event.target.parentElement.rowIndex !== undefined){
                let x = event.target.cellIndex;
                let z = event.target.parentElement.rowIndex;
                MajListe(listeCoordonnees,x,z);
            }  
        }  
    }

    function GenererTableau(){
        let tableau = document.querySelector("#table");
        tableau.innerHTML = "";
        let row;
        let d;
        for(let i=0; i<25; i++){
            row = document.createElement("tr");
            tableau.appendChild(row);
            for(let j=0; j<40; j++){
                d = document.createElement("td");
                row.appendChild(d);
            }
        }
    }
    
</script>
<style>
    table{
        border-collapse: collapse;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-user-drag: none;
        -webkit-touch-callout: none;
    }
    
    td{
        border: 1px solid rgb(173, 173, 173);
        width: 25px;
        height: 25px;
    }

    a-scene{
        width: 600px;
        height: 400px;
        border: 1px solid black;
    }

</style>
<body>
    <table id="table">
        
    </table>
    <br />
    <label for="chkgomme">Gomme</label>
    <input type="checkbox" id="chkgomme">
    (ou maintenir Alt)
    <br />
    <label for="chkporte">Porte</label>
    <input type="checkbox" id="chkporte">
    (ou maintenir Ctrl)
    <br /><br />
    <input type="button" style="color: red" value="Vider" id="btnvider">
    <br /><br />
    <input type="button" value="Générer" id="btngenerer">
    <br /><br />
    <div>
        <a-scene id="scene" embedded>
            <a-entity id="camera" position="0 1.6 0">
                <a-entity id="camera" camera look-controls wasd-controls kinematic-body foo></a-entity>
            </a-entity>
            <a-plane position="0 -2 0" static-body color="orange" width="100" height="100" rotation="-90 0 0"></a-plane>
            <a-sky color="lightblue"></a-sky>
        </a-scene>
    </div>
</body>
</html>